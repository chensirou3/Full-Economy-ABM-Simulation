# ABM 经济体模拟系统架构

## 系统概览

ABM 经济体模拟系统是一个基于多主体建模（Agent-Based Modeling）的复杂经济系统仿真平台。系统采用现代化的微服务架构，支持实时可视化、时间控制和回放功能。

### 核心特性

- **多主体建模**: 个人、家庭、企业、银行、央行等经济主体
- **实时可视化**: 2D 地图视图 + 实时指标监控
- **时间控制**: Play/Pause/Step/Speed/Jump/Rewind
- **事件溯源**: 完整的事件记录和回放能力
- **模块化架构**: 高度可扩展的组件设计
- **性能优化**: 支持大规模代理模拟

## 技术栈

### 后端
- **Python 3.11+**: 主要开发语言
- **Mesa**: 多主体建模框架
- **FastAPI**: REST API 和 WebSocket 服务
- **Pydantic**: 数据验证和序列化
- **NumPy/SciPy**: 数值计算
- **NetworkX**: 网络分析
- **Zstandard**: 快照压缩
- **PyArrow**: 高效数据存储

### 前端
- **React 18**: 用户界面框架
- **TypeScript**: 类型安全的 JavaScript
- **PixiJS**: 高性能 2D 渲染
- **Zustand**: 状态管理
- **TanStack Query**: 数据获取和缓存
- **Vite**: 构建工具

### 基础设施
- **WebSocket**: 实时数据推送
- **NDJSON**: 事件日志格式
- **JSON Schema**: 类型定义和验证

## 架构设计

### 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    前端层 (Frontend)                      │
├─────────────────────┬───────────────────────────────────┤
│   World Viewer      │      Control Tower                │
│   (React + PixiJS)  │    (React + Plotly)              │
└─────────────────────┴───────────────────────────────────┘
                              │
                    WebSocket + REST API
                              │
┌─────────────────────────────────────────────────────────┐
│                   API 层 (FastAPI)                       │
├─────────────────────────────────────────────────────────┤
│  控制端点  │  场景管理  │  快照管理  │  指标端点  │  WS    │
└─────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────┐
│                   核心模拟层                               │
├─────────────────────────────────────────────────────────┤
│           调度器 (Scheduler)                              │
│  ┌─────────────────────────────────────────────────────┐ │
│  │            经济模拟 (EconomicSimulation)             │ │
│  │  ┌─────────────┬─────────────┬─────────────────────┐ │ │
│  │  │    代理     │    市场     │       世界          │ │ │
│  │  │   Agents    │   Markets   │       World         │ │ │
│  │  └─────────────┴─────────────┴─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────┐
│                   基础设施层                               │
├─────────────────────────────────────────────────────────┤
│  遥测系统  │  事件日志  │  快照管理  │  随机数  │  配置    │
│ Telemetry │ EventLog  │ Snapshots  │   RNG   │ Config   │
└─────────────────────────────────────────────────────────┘
```

### 核心组件

#### 1. 调度器 (Scheduler)
- **职责**: 时间推进、状态管理、事件协调
- **关键功能**:
  - 模拟状态控制 (播放/暂停/步进)
  - 时间跳转和回放
  - 快照创建和恢复
  - 性能监控

#### 2. 经济模拟 (EconomicSimulation)
- **职责**: 整合所有经济组件
- **基于**: Mesa 多主体框架
- **组件**:
  - 代理调度 (RandomActivation)
  - 空间网格 (MultiGrid)
  - 市场机制
  - 指标计算

#### 3. 代理系统 (Agents)
- **基类**: BaseAgent (继承自 Mesa.Agent)
- **主要代理**:
  - Person: 个体经济行为
  - Household: 家庭决策单元
  - Firm: 企业生产和定价
  - Bank: 银行存贷和风险管理
  - CentralBank: 货币政策制定

#### 4. 市场系统 (Markets)
- **基类**: BaseMarket (订单簿机制)
- **市场类型**:
  - LaborMarket: 劳动力匹配
  - GoodsMarket: 商品交易
  - CreditMarket: 信贷市场
  - InterbankMarket: 银行间市场

#### 5. 遥测系统 (Telemetry)
- **事件总线**: 发布/订阅模式
- **指标聚合**: 实时经济指标计算
- **WebSocket**: 实时数据推送

## 数据流

### 1. 模拟执行流程

```
1. 调度器启动模拟循环
2. 对每个时间步:
   a. 执行所有代理的 step() 方法
   b. 处理市场清算
   c. 收集经济指标
   d. 记录事件日志
   e. 创建定期快照
   f. 推送实时数据到前端
3. 检查结束条件
```

### 2. 事件溯源流程

```
正常运行: 事件 → 事件日志 → 状态变更
回放模式: 快照恢复 → 事件重放 → 状态重建
```

### 3. 前后端通信

```
REST API: 控制命令、配置管理、数据查询
WebSocket: 实时指标、事件流、世界状态增量更新
```

## 扩展点设计

### W3-W4 预留扩展点

#### 1. 代理扩展
- **生命周期**: 生老病死、代际传承
- **社交网络**: 复杂关系网络、信息传播
- **学习机制**: 适应性行为、机器学习集成
- **空间行为**: 迁移决策、地理聚集

#### 2. 市场扩展
- **住房市场**: 房产交易、抵押贷款
- **国际贸易**: 进出口、汇率机制
- **金融市场**: 股票、债券、衍生品
- **平台经济**: 数字平台、网络效应

#### 3. 政策扩展
- **非常规货币政策**: QE/QT、前瞻指引
- **宏观审慎**: 系统性风险管理
- **财政政策**: 政府支出、税收
- **监管政策**: 银行监管、反垄断

#### 4. 技术扩展
- **分布式计算**: 多进程/多机器并行
- **GPU 加速**: CUDA/OpenCL 计算
- **机器学习**: 预测模型、行为建模
- **区块链**: 去中心化机制模拟

## 性能优化

### 1. 计算优化
- **Numba JIT**: 热点函数编译优化
- **NumPy 向量化**: 批量数组操作
- **并行处理**: 地理分区并行计算
- **内存管理**: 对象池、增量更新

### 2. 渲染优化
- **PixiJS**: WebGL 硬件加速
- **视口剔除**: 只渲染可见区域
- **LOD**: 距离相关的细节层次
- **帧率分离**: 模拟帧 vs 渲染帧

### 3. 网络优化
- **增量更新**: 只传输变化的数据
- **数据压缩**: WebSocket 消息压缩
- **连接池**: 复用 HTTP 连接
- **缓存策略**: 智能数据缓存

## 配置系统

### 1. 配置层次

```
默认配置 < 场景配置 < 环境变量 < 运行时参数
```

### 2. 配置验证
- **Pydantic 模型**: 类型检查和验证
- **一致性检查**: 跨模块配置验证
- **合理性检查**: 参数范围和关系验证

### 3. 场景管理
- **YAML 格式**: 人类可读的配置文件
- **版本控制**: 场景配置版本管理
- **模板系统**: 场景配置模板

## 测试策略

### 1. 单元测试
- **代理行为**: 个体决策逻辑测试
- **市场机制**: 匹配算法测试
- **工具函数**: 纯函数测试

### 2. 集成测试
- **端到端**: 完整模拟流程测试
- **API 测试**: 接口功能测试
- **性能测试**: 负载和压力测试

### 3. 性质测试
- **Hypothesis**: 基于性质的随机测试
- **不变式检查**: 经济恒等式验证
- **一致性测试**: 状态一致性检查

## 部署架构

### 1. 开发环境
- **Docker Compose**: 本地开发环境
- **热重载**: 代码变更自动重启
- **调试工具**: 断点调试、性能分析

### 2. 生产环境
- **容器化**: Docker 容器部署
- **负载均衡**: 多实例负载分担
- **监控告警**: 系统健康监控
- **日志聚合**: 集中化日志管理

### 3. 扩展部署
- **微服务**: 组件独立部署
- **消息队列**: 异步任务处理
- **数据库**: 持久化存储
- **CDN**: 静态资源加速

## 安全考虑

### 1. 输入验证
- **参数校验**: 所有输入严格验证
- **文件上传**: 安全的文件处理
- **SQL 注入**: 使用参数化查询

### 2. 访问控制
- **认证授权**: 用户身份验证
- **权限管理**: 细粒度权限控制
- **会话管理**: 安全的会话处理

### 3. 数据保护
- **敏感数据**: 加密存储和传输
- **数据备份**: 定期数据备份
- **审计日志**: 操作审计记录

## 监控和运维

### 1. 系统监控
- **性能指标**: CPU、内存、网络使用
- **业务指标**: 模拟速度、代理数量
- **错误监控**: 异常和错误追踪

### 2. 日志管理
- **结构化日志**: JSON 格式日志
- **日志级别**: 分级日志记录
- **日志轮转**: 自动日志清理

### 3. 告警机制
- **阈值告警**: 指标超限告警
- **异常告警**: 系统异常通知
- **恢复通知**: 问题解决通知

---

这个架构设计确保了系统的**可扩展性**、**可维护性**和**高性能**，为未来的功能扩展和性能优化提供了坚实的基础。
